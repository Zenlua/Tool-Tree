#!/data/data/com.tool.tree/files/home/bin/bash
set -o pipefail
source language
#threads=$(nproc)
show_help() {
  echo
  echo "Usage: cover_img -i <input> -o <output> -c <conver> -l <level> -d <delete>"
  echo
  echo "  -i    input file path"
  echo "  -o    output folder path"
  echo "  -c    file type to convert to: raw, sparse, br, dat, zstd"
  echo "  -l    compression level: 0 ~ 22, default: 8"
  echo "  -d    delete original file after conversion:"
  echo "              1: true, 0: false"
  echo "  -h    show help"
  exit 1
}

if [[ $# -eq 0 || "$1" != -* ]]; then
show_help
fi

INPUT=''; OUTPUT=''; CONVER=''; LEVEL=''; DELETE=''; show_help='';
while getopts ":i:o:c:l:d:h" opt; do
  case $opt in
    i) INPUT="$OPTARG" ;;
    o) OUTPUT="$OPTARG" ;;
    c) CONVER="$OPTARG" ;;
    l) LEVEL="$OPTARG" ;;
    d) DELETE="$OPTARG" ;;
    h) show_help ;;
    \?) echo "! Not understand -$OPTARG"; show_help ;;
    :) echo "! Lack of value for -$OPTARG"; show_help ;;
  esac
done

if [[ -z "$INPUT" ]] || [[ -z "$OUTPUT" ]] || [[ -z "$CONVER" ]]; then
echo "Incorrect input, output or conversion format, please check again" >&2
show_help
fi

[[ -z "$LEVEL" ]] && LEVEL=8
[[ -z "$DELETE" ]] && DELETE=0

# kiểm tra dạng file đầu vào
dang_type="$(checktype "$INPUT")"
logcv="$TMP/log_conver.txt"
namerd="tmp_cv$RANDOM"
namesv="$(echo "${INPUT##*/}" | sed 's/\..*$//')"

process_count(){
PIDK=$!
num1="$1"; num2="$2";
while kill -0 $PIDK 2>/dev/null; do
if [ -f "$num2" ];then
    num3=$(tr '\r' '\n' < "$num2" | awk '/ : /{v=$3} END{print v}')
    if [ "$num3" ];then
    [ "${num3:-0}" == "${num4:-1}" ] || progress "$((num3 * 100 / num1))/100"
    num4="$num3"
    fi
fi
sleep 1
done
progress -1/0
}

if [[ "$dang_type" == "$CONVER" ]]; then
killtree "The input file is: $namesv ($dang_type), and you want to convert to: ($CONVER) ???"
fi
rm -f "$logcv"
mkdir -p "$OUTPUT"

# Xử lý các tệp nén
if [ "$dang_type" == 'zstd' ];then
echo -e "$unpack_text_0 (${INPUT##*/}) ➠ ($CONVER)...\n"
size_zstd="$(zstd -lv "$INPUT" 2>/dev/null | awk -F'[()]' '/Decompressed Size/ {print $2}' | awk '{print $1}')"
zstd --progress -vv -f -d -k "$INPUT" -o "$TMP/$namerd" &>>$logcv &
process_count "$size_zstd" "$logcv"
elif [ "$dang_type" == 'br' ];then
echo -e "$unpack_text_0 (${INPUT##*/}) ➠ ($CONVER)...\n"
brotli -vf -d "$INPUT" -o "$TMP/$namerd" &>>$logcv
    if [ "$(checktype "$TMP/$namerd")" == 'dat' ];then
    [ -f "${INPUT%%.*}.transfer.list" ] || killtree "Missing file: ${INPUT%%.*}.transfer.list"
    sdat2img "${INPUT%%.*}.transfer.list" "$TMP/$namerd" "$TMP/2_$namerd" &>>$logcv
    [ -f "$TMP/2_$namerd" ] && mv "$TMP/2_$namerd" "$TMP/$namerd" || killtree "Conversion failed error !!!"
    fi
elif [ "$dang_type" == 'dat' ];then
[ -f "${INPUT%%.*}.transfer.list" ] || killtree "Missing file: ${INPUT%%.*}.transfer.list"
echo -e "$unpack_text_0 (${INPUT##*/}) ➠ ($CONVER)...\n"
sdat2img "${INPUT%%.*}.transfer.list" "$INPUT" "$TMP/$namerd" &>>$logcv
fi

# xử lý sparse
if [ "$(checktype "$INPUT")" == 'sparse' ];then
echo -e "$unpack_text_0 (${INPUT##*/}) ➠ ($CONVER)...\n"
simg2img "$INPUT" "$TMP/$namerd" &>>$logcv
fi

# nhận file
if [ -f "$TMP/$namerd" ];then
file_img="$TMP/$namerd"
else
file_img="$INPUT"
fi

echo -e "$unpack_text_0 (${file_img##*/}) ➠ ($CONVER)...\n"

# chuyển đổi
if [ "$CONVER" == 'zstd' ] || [ "$CONVER" == 'gz' ] || [ "$CONVER" == 'xz' ] || [ "$CONVER" == 'lz4' ] || [ "$CONVER" == 'lzma' ];then
    zstd --progress -f -$LEVEL --format=$CONVER --compress "$file_img" -o "$OUTPUT/$namesv.img.$CONVER" &>>$logcv
    PIDK=$!
    while kill -0 $PIDK 2>/dev/null; do
    if [ -f "$logcv" ];then
        num2="$(tr '\r' '\n' < "$logcv" | awk '/Read:/{r=$2*($3=="GiB"?1024:1); t=$5*($6=="GiB"?1024:1)} END{print (t>0?int(r/t*100):0)}')"
        if [ "$num2" ];then
        [ "${num2:-0}" == "${num4:-1}" ] || progress "$num2/100"
        num4="$num2"
        fi
    fi
    sleep 1
    done
    progress -1/0
elif [ "$CONVER" == 'dat' ];then
    if [ -f "$TMP/$namerd" ];then
    img2simg $file_img &>>$logcv
    else
    img2simg "$file_img" "$TMP/$namerd" &>>$logcv
    file_img="$TMP/$namerd"
    fi
img2sdat "$file_img" -o "$OUTPUT" -v 4 -p $namesv &>>$logcv
elif [ "$CONVER" == 'br' ];then
LEVEL="$(echo "$LEVEL / 2" | bc)"
    if [ -f "$TMP/$namerd" ];then
    img2simg $file_img &>>$logcv
    else
    img2simg "$file_img" "$TMP/$namerd" &>>$logcv
    file_img="$TMP/$namerd"
    fi
img2sdat "$file_img" -o "$OUTPUT" -v 4 -p $namesv &>>$logcv
[ -f "$OUTPUT/$namesv.new.dat" ] || killtree "Error creating file $namesv.new.dat failed !!!"
brotli -vfq "$LEVEL" "$OUTPUT/$namesv.new.dat" -o "$OUTPUT/$namesv.new.dat.br" &>>$logcv
rm -fr "$OUTPUT/$namesv.new.dat"
elif [ "$CONVER" == 'sparse' ];then
img2simg "$file_img" "$OUTPUT/$namesv.img"
else
    if [ "$file_img" == "$INPUT" ];then
    killtree "Nothing to convert !!!"
    else
    mv -f "$file_img" "$OUTPUT/$namesv.img"
    fi
fi

# xác nhận để xóa rác
if [ "$file_img" != "$INPUT" ];then
[ -f "$file_img" ] && rm -fr "$file_img"
fi

# xoá file cũ
[ "$DELETE" == 1 ] && rm -fr "$INPUT"
