#!/data/data/com.tool.tree/files/home/bin/bash

if [ "$1" == '-h' ] || [ "$1" == '--help' ] || [ -z "$1" ];then
echo "downloadb http://file.zip save.zip"
exit
fi

source language
ranid="$RANDOM"
echo "noti:[id=$ranid title='$download_text' message='$load_text_1']"
taive_index="$(curl -sIL "$1")"
if [ "$?" == 0 ];then
taive_byte="$(echo "$taive_index" | grep -i "content-length" | awk '{print $2}' | tail -n 1)"
taive_name="$(echo "$taive_index" | grep -i filename= | tail -n 1 | cut -d= -f2 | awk '{print $1}')"
    if [ "$2" ];then
    taive_path_file="$(realpath "$2")"
    [ -f "$taive_path_file" ] && rm -fr "$taive_path_file"
    else
    [ "$taive_name" ] && taive_path_kk="$(realpath $taive_name)" || taive_path_kk="$(realpath Download.bin)"
    taive_path_file="$(checkname "$taive_path_kk")"
    fi
(
taive_byte_hientai=0
echo >$TMPDIR/downloadb_$ranid.log
while true; do
    if [ "$taive_byte" != 0 ]; then
    echo "noti:[id=$ranid title='$name_text: ${taive_path_file##*/}' message='$sizes_text: $(coverbyte $taive_byte_hientai)/$(coverbyte $taive_byte)']"
    else
    echo "noti:[id=$ranid title='$name_text: ${taive_path_file##*/}' message='$sizes_text: $(coverbyte $taive_byte_hientai)']"
    fi
[ -f "$taive_path_file" ] && taive_byte_hientai=$(wc -c <"$taive_path_file" 2>/dev/null)
    if [ "$(grep -cm1 'notification=0' $TMPDIR/downloadb_$ranid.log 2>/dev/null)" == 1 ];then
    echo "noti:[id=$ranid title='$name_text: ${taive_path_file##*/}' message='$flash_text_12']"
    sleep 3
    [ "$3" == "true" ] && echo "noti:[delete=true id=$ranid]"
    rm -fr $TMPDIR/downloadb_$ranid.log
    break
    elif [ "$(grep -cm1 notification= $TMPDIR/downloadb_$ranid.log 2>/dev/null)" == 1 ];then
    echo "noti:[id=$ranid title='Error: ${taive_path_file##*/}' message='($(gprop notification $TMPDIR/downloadb_$ranid.log)) $load_text_2']"
    rm -fr $TMPDIR/downloadb_$ranid.log
    break
    else
        if [ ! -f $TMPDIR/downloadb_$ranid.log ];then
        echo "noti:[delete=true id=$ranid]"
        break
        fi
    fi
sleep 1
done
) &


Taive "$1" "$taive_path_file"
echo "notification=$?" &>$TMPDIR/downloadb_$ranid.log
else
echo "noti:[delete=true id=$ranid]"
echo "$load_text_2" >&2
exit 1
fi
