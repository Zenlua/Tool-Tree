<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Terminal</title>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 12px;
            background: #0d1117;
            color: #c9d1d9;
            font-family: monospace;
            display: flex;
            flex-direction: column;
            height: 100dvh;
        }
        h3 { margin: 0 0 10px; font-size: 16px; color: #58a6ff; }
        .terminal {
            background: #010409;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
        }
        textarea {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            color: #c9d1d9;
            font-size: 15px;
            font-family: monospace;
            resize: none;
            line-height: 1.4;
        }
        .action-bar {
            display: flex;
            align-items: center;
        }
        .action-bar .spacer { flex: 1; }
        button {
            background: #238636;
            border: none;
            color: white;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        button.copy { background: #1f6feb; }
        pre {
            margin-top: 10px;
            padding: 10px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            font-size: 14px;
            flex: 1;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }
    </style>
</head>

<body>

    <h3>Web Terminal</h3>

    <div class="terminal">
        <textarea id="cmd" rows="2" placeholder="#!/system/bin/sh" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"></textarea>
    </div>

    <div class="action-bar">
        <button id="runBtn" onclick="runCmd()">üöÄ Run</button>
        <div class="spacer"></div>
        <button class="copy" onclick="copyOutput()">üìã Copy</button>
    </div>

    <pre id="output"></pre>

    <script>
        var input = document.getElementById("cmd");
        var output = document.getElementById("output");
        var runBtn = document.getElementById("runBtn");
        
        var minRows = 2;
        var maxRows = 12;
        
        function autoResize() {
            var lines = input.value.split("\n").length;
            input.rows = Math.min(maxRows, Math.max(minRows, lines));
        }
        input.addEventListener("input", autoResize);
        
        function shellEscape(str) {
            return str.replace(/\\/g, "\\\\")
                      .replace(/"/g, '\\"')
                      .replace(/\$/g, "\\$")
                      .replace(/`/g, "\\`");
        }
        
        function saveCode(code) {
            if (!code) return;
            try {
                var escaped = shellEscape(code);
                KrScriptCore.executeShell('slog code_shell_text "' + escaped + '"');
            } catch(e){}
        }
        
        function loadCode() {
            try {
                var result = KrScriptCore.executeShell("glog code_shell_text 2>/dev/null");
                if (result && result.trim()) {
                    input.value = result;
                    autoResize();
                }
            } catch(e){}
        }
        loadCode();
        input.addEventListener("input", function() {
            autoResize();
            saveCode(input.value);
        });
        
        function wrapCmd(cmd) {
            return "{\n" + cmd + "\n} 2>&1";
        }
        
        function runCmd() {
            var rawCmd = input.value.trim();
            if (!rawCmd) return;
        
            runBtn.textContent = "‚è≥ Running...";
            output.textContent = "";
        
            setTimeout(function() {
                try {
                    var execCmd = wrapCmd(rawCmd);
                    var result = KrScriptCore.executeShell(execCmd);
                    output.textContent = result;
                } catch(e) {
                    output.textContent = "Error: " + e;
                } finally {
                    runBtn.textContent = "üöÄ Run";
                }
                output.scrollTop = output.scrollHeight;
            }, 50);
        }
        
        function copyOutput() {
            var text = output.innerText;
            if (!text) return;
            navigator.clipboard.writeText(text);
        }
    </script>

</body>

</html>